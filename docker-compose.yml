version: "3.8"

services:
  # ── Frontend (Next.js) ──
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    environment:
      - NEXT_PUBLIC_API_URL=/api/v1
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "5"
    networks:
      - imputex

  # ── Nginx Reverse Proxy ──
  nginx:
    image: nginx:1.25-alpine
    ports:
      - "80:80"
      # - "443:443"  # 도메인 발급 후 활성화
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      # - certbot_www:/var/www/certbot:ro        # 도메인 발급 후 활성화
      # - certbot_conf:/etc/letsencrypt:ro       # 도메인 발급 후 활성화
    depends_on:
      api:
        condition: service_healthy
      frontend:
        condition: service_started
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "5"
    networks:
      - imputex

  # ── Certbot (Let's Encrypt) — 도메인 발급 후 주석 해제 ──
  # certbot:
  #   image: certbot/certbot
  #   volumes:
  #     - certbot_www:/var/www/certbot
  #     - certbot_conf:/etc/letsencrypt
  #   entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done'"
  #   restart: unless-stopped
  #   logging:
  #     driver: json-file
  #     options:
  #       max-size: "10m"
  #       max-file: "5"
  #   networks:
  #     - imputex

  # ── FastAPI Application ──
  api:
    build:
      context: ./backend
      dockerfile: docker/Dockerfile.api
    env_file:
      - ./backend/.env
    environment:
      - DATABASE_URL=postgresql+psycopg2://imputex:imputex_password@postgres:5432/imputex
      - REDIS_URL=redis://redis:6379/0
      - UPLOAD_DIR=/app/uploads
      - RESULT_DIR=/app/results
    volumes:
      - upload_data:/app/uploads
      - result_data:/app/results
      - ${TOTEM_MODEL_HOST_PATH:-./models/totem}:/app/models/totem:ro
      - ${TOTEM_CODE_HOST_PATH:-./TOTEM/TOTEM}:/app/TOTEM:ro
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "5"
    networks:
      - imputex

  # ── Celery Worker ──
  worker:
    build:
      context: ./backend
      dockerfile: docker/Dockerfile.worker
    env_file:
      - ./backend/.env
    environment:
      - DATABASE_URL=postgresql+psycopg2://imputex:imputex_password@postgres:5432/imputex
      - REDIS_URL=redis://redis:6379/0
      - UPLOAD_DIR=/app/uploads
      - RESULT_DIR=/app/results
    volumes:
      - upload_data:/app/uploads
      - result_data:/app/results
      - ${TOTEM_MODEL_HOST_PATH:-./models/totem}:/app/models/totem:ro
      - ${TOTEM_CODE_HOST_PATH:-./TOTEM/TOTEM}:/app/TOTEM:ro
    # NVIDIA GPU 지원 (nvidia-container-toolkit 설치 필요)
    # GPU가 없으면 이 섹션을 주석 처리하거나 docker-compose.gpu.yml로 분리
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: all
    #           capabilities: [gpu]
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "5"
    networks:
      - imputex

  # ── PostgreSQL ──
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: imputex
      POSTGRES_PASSWORD: imputex_password
      POSTGRES_DB: imputex
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U imputex"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "5"
    networks:
      - imputex

  # ── Redis ──
  redis:
    image: redis:7-alpine
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "5"
    networks:
      - imputex

volumes:
  postgres_data:
  redis_data:
  upload_data:
  result_data:
  # certbot_www:    # 도메인 발급 후 활성화
  # certbot_conf:   # 도메인 발급 후 활성화

networks:
  imputex:
    driver: bridge
